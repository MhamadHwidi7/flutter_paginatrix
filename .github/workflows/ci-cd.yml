name: CI/CD Pipeline

# When to run
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  # Job 1: Test and validate code
  test:
    name: Test and Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Get example dependencies
        run: |
          for example in examples/*/; do
            if [ -f "$example/pubspec.yaml" ]; then
              echo "Installing dependencies for $example"
              cd "$example" && flutter pub get && cd ../..
            fi
          done

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Format code
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        run: dart analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false

  # Job 2: Publish to pub.dev (only on version tags like v1.0.0)
  publish:
    name: Publish to pub.dev
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Format code
        run: dart format --set-exit-if-changed .

      - name: Analyze code (strict)
        run: dart analyze --fatal-infos

      - name: Run tests
        run: dart test

      - name: Validate version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "üì¶ Version: $VERSION"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(\+[0-9]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            exit 1
          fi

      - name: Check CHANGELOG
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          if [ -f "CHANGELOG.md" ]; then
            if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
              echo "‚ö†Ô∏è  Warning: CHANGELOG.md doesn't have entry for version $VERSION"
            fi
          fi

      - name: Dry-run publish
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        run: dart pub publish --force
        env:
          PUB_TOKEN: ${{ secrets.PUB_DEV_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
